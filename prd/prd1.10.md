# 产品需求文档：后台任务管理页面 - V1.10

## 1. 綜述 (Overview)
### 1.1 项目背景与核心问题
当前系统的核心数据处理流程（V1.2数据预处理、V1.5 AI提取）被设计为每日凌晨自动执行的定时任务。该模式虽适用于生产环境，但对于系统开发、调试、测试以及紧急数据补录等场景，存在严重的时效性问题。测试人员无法立即验证其操作结果，必须等待数小时。V1.10版本的核心目标是为系统管理员提供一个内部管理工具，允许其手动触发这些后台任务，从而解决测试和运维过程中的效率瓶颈。

### 1.2 核心业务流程 / 用户旅程地图
V1.10版本为管理员/测试人员定义了一个专用的工作流程：
1.  **阶段一：访问入口** - 管理员在正常登录系统后，通过一个预先约定的、不在主导航中显示的“秘密”URL，直接访问“后台任务管理”页面。
2.  **阶段二：触发数据预处理** - 在管理页面上，管理员选择一个日期范围，然后点击按钮，手动触发V1.2的数据预处理与聚合任务。
3.  **阶段三：触发AI提取** - 在数据预处理完成后，管理员点击另一个按钮，手动触发V1.5的AI自动化提取任务。
4.  **阶段四：验证结果** - 任务触发后，管理员可前往“审核工作台”页面，验证新生成的FAQ是否已按预期出现。

## 2. 用户故事详述 (User Stories)

### 阶段一：手动任务触发

---

#### **US-1.10: 作为一名系统管理员/测试员，我希望能通过一个专门的管理页面来手动触发后台数据处理任务，以便我能方便快捷地进行系统测试和数据验证。**
*   **价值陈述 (Value Statement)**:
    *   **作为** 一名系统管理员/测试员
    *   **我希望** 能在一个简单的UI界面上，按需、即时地启动V1.2（数据预处理）和V1.5（AI提取）两个独立的后台任务
    *   **以便于** 我能摆脱对每日定时任务的依赖，随时验证系统的数据处理逻辑，并高效地完成功能测试和问题排查。
*   **业务规则与逻辑 (Business Logic)**:
    1.  **访问控制 (极简方案)**:
        *   本功能页面**不**在系统主导航栏中设置任何可见的入口链接或按钮。
        *   访问方式为通过一个预先约定的、复杂度较高的**“秘密”URL**（如 `/internal-tasks/trigger-panel-ab12cd34`）直接访问。
        *   页面的访问前提是用户**必须已登录**。前端路由守卫会确保未登录用户无法访问此URL。
        *   本版本**不引入**基于角色的访问控制（RBAC）。后台API的安全校验仅检查用户是否已登录（JWT有效性），不检查用户角色。
    2.  **页面功能 - 数据预处理 (V1.2触发器)**:
        *   页面提供一个日期范围选择器。
        *   用户点击【执行数据预处理】按钮后，前端调用`POST /api/v1.10/admin/trigger-aggregation` API，请求体中需包含所选的起止时间。
        *   API调用成功后，前端需给出明确的反馈信息，如：“数据预处理任务已启动，请稍后查看数据库。”
    3.  **页面功能 - AI提取 (V1.5触发器)**:
        *   页面提供一个【执行AI提取】按钮。
        *   用户点击后，前端调用`POST /api/v1.10/admin/trigger-extraction` API。该API可无请求体，代表处理所有待处理的对话。
        *   API调用成功后，前端需给出明确的反馈信息，如：“AI提取任务已启动，请稍后刷新审核工作台查看结果。”
*   **验收标准 (Acceptance Criteria)**:
    *   **场景1: 访问控制**
        *   **GIVEN** 我是一个已登录的普通审核员
        *   **WHEN** 我通过某种方式得知并访问了那个“秘密”URL
        *   **THEN** 我应该能看到“后台任务管理”页面。当我点击页面上的任一执行按钮时，后台API应能成功调用（因为本版本不做角色校验）。
    *   **场景2: 成功触发数据预处理**
        *   **GIVEN** 我在管理页面选择了“昨天”的日期范围
        *   **WHEN** 我点击【执行数据预处理】按钮
        *   **THEN** 前端应成功调用`/trigger-aggregation` API，并将正确的日期范围作为参数传递，同时页面上应显示任务已启动的提示。
    *   **场景3: 成功触发AI提取**
        *   **GIVEN** `prepared_conversations`表中存在待处理的数据
        *   **WHEN** 我点击【执行AI提取】按钮
        *   **THEN** 前端应成功调用`/trigger-extraction` API，并显示任务已启动的提示。稍后，我能在“审核工作台”看到新生成的FAQ。

---
*   **技术实现概要 (Technical Implementation Brief)**:
    *   **前端**:
        *   **技术栈**: React + Ant Design
        *   **实现**: 创建一个新的页面组件和路由。路由地址应设置为一个复杂度较高的路径。页面中使用`Card`, `DatePicker`, `Button`等组件构建UI。
    *   **后端**:
        *   新增两个独立的API Endpoint，用于接收手动触发请求。
        *   API的控制器层需添加安全校验，确保调用者已登录。
    *   **页面布局线框图 (ASCII Wireframe)**:
        ```text
        +------------------------------------------------------------------------------------------+
        | FAQ 智能挖掘系统      当前知识库: [ 水务知识库 ]                     [用户: 水务管理员 v] |
        +==========================================================================================+
        | 系统管理 > 后台任务触发                                                                    |
        |------------------------------------------------------------------------------------------|
        |                                                                                          |
        | +----------------------------------------------------------------------------------------+ |
        | | **数据预处理与聚合 (V1.2)**                                                        | |
        | | ---------------------------                                                        | |
        | |  选择处理日期范围: [ YYYY-MM-DD ] 至 [ YYYY-MM-DD ]         [ 执行数据预处理 ]         | |
        | | <说明> 点击后，系统将从源数据库拉取指定范围内的对话，进行聚合与格式化。             | |
        | +----------------------------------------------------------------------------------------+ |
        |                                                                                          |
        | +----------------------------------------------------------------------------------------+ |
        | | **AI自动化提取 (V1.5)**                                                            | |
        | | ---------------------                                                            | |
        | | <说明> 点击后，系统将处理当前所有已准备好的对话，调用AI提取FAQ。                   | |
        | |                                                             [ 执行AI提取 ]             | |
        | +----------------------------------------------------------------------------------------+ |
        |                                                                                          |
        +------------------------------------------------------------------------------------------+
        ```
*   **数据模型 / 接口契约 (Data Contracts & APIs)**:

    *   **API Endpoint 1: 手动触发数据预处理**
        *   **`POST /api/v1.10/admin/trigger-aggregation`**
        *   **请求体**:
            ```json
            {
              "startTime": "2024-10-30T00:00:00Z",
              "endTime": "2024-10-30T23:59:59Z"
            }
            ```
        *   **成功响应 (202 Accepted)**: `{"jobId": "agg-job-123", "message": "Aggregation task triggered."}`

    *   **API Endpoint 2: 手动触发AI提取**
        *   **`POST /api/v1.10/admin/trigger-extraction`**
        *   **请求体**: (可选，可为空)
            ```json
            {
              "limit": 10 // 可选参数，用于快速测试少量数据
            }
            ```
        *   **成功响应 (202 Accepted)**: `{"jobId": "ext-job-456", "message": "Extraction task triggered."}`

*   **约束与边界 (Constraints & Boundaries)**:
    *   本功能的访问控制依赖于URL的隐匿性，不进行基于角色的权限校验。这是一个为了快速实现测试工具而接受的权衡。
    *   前端页面不提供任务状态的轮询和展示功能，仅做触发。