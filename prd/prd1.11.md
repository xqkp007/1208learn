# 产品需求文档：AICO同步流程优化 - V1.11

## 1. 綜述 (Overview)
### 1.1 项目背景与核心问题
当前V1.3版本的AICO同步服务依赖于`upload`接口自带的“覆盖”模式来更新知识库。为增强数据同步流程的健壮性与确定性，避免对“覆盖”这种隐式行为的依赖，V1.11版本需要对同步流程进行优化。核心目标是在上传新知识文件前，增加一个显式的“删除旧文件”步骤，将同步模式升级为更清晰、更可控的“先删后增”模式。这能从根本上确保每次同步都是在一个干净的环境中进行，从而杜绝因覆盖不完全或行为不符合预期而导致的数据残留或不一致问题。

### 1.2 核心业务流程 / 用户旅程地图
V1.11版本是对V1.3后台同步服务的内部逻辑优化，不涉及用户界面变更。其核心后台流程将在原有的“八步走”基础上，升级为“九步走”：
1.  **准备阶段 (1-4步)**: (不变) 盘点内部知识、生成文件、获取AICO认证与ID。
2.  **【核心变更】清理阶段 (第5步)**: **(新增)** 调用AICO API，将目标知识库中由本系统上次同步的文件全部删除。
3.  **执行阶段 (6-9步)**: (不变) 上传新文件、轮询状态、触发切片与最终上线。

## 2. 用户故事详述 (User Stories)

### 阶段一：同步服务逻辑优化

---

#### **US-1.11: 作为后台同步服务，我需要在上传新知识前先将AICO知识库中的旧文件清空，以便实现一个更可靠的“先删后增”式同步。**
*   **价值陈述 (Value Statement)**:
    *   **作为** 后台同步服务
    *   **我希望** 在执行全量同步任务时，能够先通过API调用显式地删除AICO知识库中的存量文件，然后再上传新的文件
    *   **以便于** 消除对“覆盖”模式隐式行为的依赖，让每一次同步都在一个确定的、干净的状态下开始，从而最大化地保证数据的一致性和同步的可靠性。
*   **业务规则与逻辑 (Business Logic)**:
    1.  **触发条件**: 本优化逻辑应用于V1.3中定义的所有触发场景（每日定时任务、手动触发）。
    2.  **流程变更点**: 在原V1.3 API调用编排的第4步（确认`pid`和`kb_id`）和原第5步（上传文件）之间，插入一个新的核心步骤。
    3.  **新增步骤：“清空旧文件”**:
        *   **A. 获取文件列表**: 使用已获取的`pid`和`kb_id`，调用AICO的`GET .../file/show`接口，获取当前知识库下所有文件的列表。
        *   **B. 筛选目标文件**: （可选，但推荐）为避免误删非本系统管理的文件，可以根据文件名规则（如`water_kb_autosync.csv`）进行筛选。
        *   **C. 循环删除**: 遍历上一步获取到的文件列表，获取每个文件的`file_id`，然后循环调用AICO的**“删除文件”API**，将这些文件逐一删除。
        *   **D. 错误处理**:
            *   如果获取文件列表失败，或删除过程中任一文件失败，整个同步任务应标记为失败，并记录详细错误日志，**不应继续执行**后续的上传步骤。
            *   如果知识库本身为空，获取到的文件列表为空，则此步骤应正常跳过，继续执行上传。
    4.  **后续流程**: “清空旧文件”步骤成功执行完毕后，继续执行后续的文件上传、切片和上线流程。
*   **验收标准 (Acceptance Criteria)**:
    *   **场景1: 成功执行“先删后增”**
        *   **GIVEN** AICO“水务”知识库中存在一个由上次同步创建的文件`file_A`
        *   **WHEN** V1.11的同步任务被触发
        *   **THEN** 通过系统日志或网络请求监控，应能观测到系统先调用了“删除文件”API（目标为`file_A`），成功后再调用了“上传文件”API。最终，AICO知识库中应只包含新上传的文件，而`file_A`已不存在。
    *   **场景2: 删除失败则中止**
        *   **GIVEN** AICO的“删除文件”API因故返回错误
        *   **WHEN** V1.11的同步任务执行到“清空旧文件”步骤
        *   **THEN** 整个同步任务应立即中止并标记为失败，不应向AICO发起任何“上传文件”的请求。

---
*   **技术实现概要 (Technical Implementation Brief)**:
    *   **影响范围**: 纯后端服务 (V1.3 AICO同步与编排服务)
    *   **后端 (Backend)**:
        *   修改`AicoSyncOrchestrator`服务。
        *   在核心的`executeSync`方法中，增加调用删除API的逻辑。
        *   需要封装一个新的`aicoApiClient.deleteFile(fileId)`方法。
    *   **API依赖 (外部)**:
        *   本版本的实现**强依赖**于AICO平台提供一个稳定、幂等的“按文件ID删除文件”的API。
*   **数据模型 / 接口契约 (Data Contracts & APIs)**:

    *   **需要确认的外部API: 删除文件**
        *   **Endpoint (待定)**: `DELETE /aicoapi/knowledge_manage/file/{file_id}` (此为根据已有API推测的路径，需最终确认)
        *   **路径参数**: `file_id` (int): 要删除的文件的唯一ID。
        *   **Headers**: `Authorization: Bearer {token}`
        *   **成功响应 (待定)**: 期望为`200 OK`或`204 No Content`。
        *   **失败响应 (待定)**: 期望有明确的错误码，如`404 Not Found`（文件不存在）、`403 Forbidden`（无权限）等。

*   **开放问题与待确认事项 (Open Questions & Follow-ups)**:
    *   **[高优先级]** 需向AICO平台方**确认**“删除知识库文件”的**具体API Endpoint、请求方式、参数和响应格式**。本文档的最终实现，以此确认为准。
    *   需确认删除操作是同步还是异步的。如果是异步的，则在删除后、上传前，需要增加轮询文件列表以确认删除成功的逻辑。